<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="referrer" content="never">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="stylesheet" href="movie.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1080722_jbbsm8bqj.css">
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <title>移动端豆瓣电影</title>
</head>

<body>
    <main>
        <section>111</section>
        <section>222</section>
        <section>333</section>
    </main>
    <footer>
        <div class="active"><span class="iconfont icon-top"></span><span>Top250</span></div>
        <div><span class="iconfont icon-us"></span><span>北美</span></div>
        <div><span class="iconfont icon-sousuo"></span><span>搜索</span></div>
    </footer>
</body>
<script>
    $('footer>div').click(function() {
        var index = $(this).index()
        $('section').hide().eq(index).fadeIn() //所有sec标签隐藏,选中的标签飞入
        $(this).addClass('active').siblings().removeClass('active') //点击的div添加active类,邻居移除active类
    })
    var index = 0 //将后台数据的位置抽离出来,便于调用
        // 点击切换
    start() //在打开页面时调用一次
    function start() {
        $.ajax({
            url: 'http://api.douban.com/v2/movie/top250', //后台数据接口
            type: 'GET', //获取方式
            data: {
                start: index,
                count: 20,
            }, //数据长度
            dataType: 'jsonp', //此处使用了jsonp进行跨域
        }).done(function(ret) { //接到ret数据
            console.log(ret)
            setData(ret) //将ret数据传入设置函数
            index += 20; //将初始值位置增加20
        }).fail(function() {
            console.log('error')
        })
    } //将ajax请求封装成函数,便于滚动页面时再次调用
    $('main').scroll(function() {
        if ($('section').eq(0).height() - 10 <= $('main').scrollTop() + $('main').height()) {
            start() //在这里再次执行start函数,调用后台数据
        } //判断页面是否到底,原理是页面宽度=滚动长度+可视页面高度
    })

    function setData(data) {
        data.subjects.forEach(function(movie) {
            var template = `<div class="item">
      <a href="#">
      <div class="cover">
      <img src="" alt="">
          </div>
      <div class="detail">
      <h2></h2>
      <div class="extra"><span class="score"></span>分 / <span class="collect"></span>收藏</div>
      <div class="extra"><span class="year"></span> / <span class="type"></span></div>
      <div class="extra">导演: <span class="director"></span></div>
      <div class="extra">主演: <span class="actor"></span></div>
    </div>
    </a>
    </div>` //定义放入dom的字符串
            var $node = $(template) //选中此节点
            $node.find('.cover img').attr('src', movie.images.medium) //替换img的src属性
            $node.find('.detail h2').text(movie.title) //替换标题中的文本
            $node.find('.score').text(movie.rating.average)
            $node.find('.collect').text(movie.collect_count)
            $node.find('.year').text(movie.year)
            $node.find('.type').text(movie.genres.join(' / '))
            $node.find('.director').text(function() {
                var directorsArr = [] //导演作为数组,需要将其转换为字符串,此处先定义空数组
                movie.directors.forEach(function(item) {
                    directorsArr.push(item.name) //将后台数据的每一项拼接至空数组内
                })
                return directorsArr.join('、') //使用join方法转换为字符串
            })
            $node.find('.actor').text(function() {
                var actorArr = []
                movie.casts.forEach(function(item) {
                    actorArr.push(item.name)
                })
                return actorArr.join('、')
            })


            $('section').eq(0).append($node) //将node节点放至到sec标签的第一个位置
        })
    }
</script>

</html>